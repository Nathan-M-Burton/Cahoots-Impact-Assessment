<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Replicating the Police Diversion Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="police_replication_files/libs/clipboard/clipboard.min.js"></script>
<script src="police_replication_files/libs/quarto-html/quarto.js"></script>
<script src="police_replication_files/libs/quarto-html/popper.min.js"></script>
<script src="police_replication_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="police_replication_files/libs/quarto-html/anchor.min.js"></script>
<link href="police_replication_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="police_replication_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="police_replication_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="police_replication_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="police_replication_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Replicating the Police Diversion Analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This document provides a breakdown and replication of the methodology used in the 2021 review of the Cahoots organization done by the EPD Crime Analysis unit. Below are the formulas used in the calculation of the diversion rates mentioned in the paper. (Formulations Have not yet been updated to reflect code changes)</p>
<section id="gross-diversion-rates" class="level3">
<h3 class="anchored" data-anchor-id="gross-diversion-rates">Gross Diversion Rates</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Rate</th>
<th>Formula</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Diversion Rate 1</strong></td>
<td><span class="math inline">\(\frac{\text{CAHOOTS Associations}}{\text{Total Calls}}\)</span></td>
<td>This rate represents all instances where CAHOOTS was associated with a call, regardless of dispatch or arrival status.</td>
</tr>
<tr class="even">
<td><strong>Diversion Rate 2</strong></td>
<td><span class="math inline">\(\frac{\text{CAHOOTS Dispatched}}{\text{Total Calls}}\)</span></td>
<td>This rate considers calls where CAHOOTS was dispatched.</td>
</tr>
<tr class="odd">
<td><strong>Diversion Rate 3</strong></td>
<td><span class="math inline">\(\frac{\text{CAHOOTS Only Arrived}}{\text{Total Calls}}\)</span></td>
<td>This rate considers all calls where CAHOOTS alone arrived at the scene.</td>
</tr>
</tbody>
</table>
</section>
<section id="adjusted-diversion-rates" class="level3">
<h3 class="anchored" data-anchor-id="adjusted-diversion-rates">Adjusted Diversion Rates</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Rate</th>
<th>Formula</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Diversion Rate 4</strong></td>
<td><span class="math inline">\(\frac{\text{CAHOOTS Only Arrived} - (\text{Count of top 3 Cahoots incidents (dataset 5)})}{\text{Total Calls}}\)</span></td>
<td>Removes the total count of the 3 most common call types handled by Cahoots from the numerator.</td>
</tr>
<tr class="even">
<td><strong>Diversion Rate 5</strong></td>
<td><span class="math inline">\(\frac{\text{CAHOOTS Only Arrived} - (\text{Count of top 3 Cahoots incidents (dataset 5)})}{\text{(Arrived only calls) - (Count of top 3 Cahoots incidents (dataset 5))}}\)</span></td>
<td>Similar to Diversion Rate 4, but only considers calls that arrived on scene.</td>
</tr>
<tr class="odd">
<td><strong>Diversion Rate 6 (Low)</strong></td>
<td><span class="math inline">\(\frac{\text{(Count of Dispatched Cahoots Welfare Calls) * 0.74}}{\text{Total Calls}}\)</span></td>
<td>Assumes that Welfare check is the only diverted call type and that 0.74 are diversions.</td>
</tr>
<tr class="even">
<td><strong>Diversion Rate 6 (High)</strong></td>
<td><span class="math inline">\(\frac{\text{(Count of Dispatched Cahoots Welfare Calls) * 0.74}}{\text{(Dispatched only calls) - (Arrival count of Cahoots incidents - wellfare count)}}\)</span></td>
<td>Similar to Diversion Rate 6 (Low), but calculated using the adjusted total for dispatched calls (arrived only).</td>
</tr>
</tbody>
</table>
</section>
<section id="police-diverson-criteria" class="level1">
<h1>Police Diverson Criteria</h1>
<ul>
<li>Call is recieved by the call center</li>
<li>Police are normally dispatched to call type</li>
<li>The call is dispatched to and arrived at by Cahoots</li>
<li>No EPD Resources are dispatched to the call</li>
</ul>
</section>
<section id="exact-replication-of-the-numbers" class="level1">
<h1>Exact Replication of the numbers</h1>
<p>The exact calculations are not provided in the study so I extracted the relevant counts from the available figures, and just used the stated number when raw totals were not visable. The fact that many exact calculations are not shown means that some re-engineering was involved in deriving these formulas.</p>
<div id="cell-5" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- CAHOOTS Data ---</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>cahoots_total_assoc <span class="op">=</span> <span class="dv">22055</span> </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># dispatch</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>cahoots_dispatches <span class="op">=</span> <span class="dv">18106</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>cahoots_dispatches_check_welfare <span class="op">=</span> <span class="dv">5546</span> <span class="co"># 6003</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>cahoots_dispatches_transport <span class="op">=</span> <span class="dv">1803</span> </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>cahoots_dispatches_assist <span class="op">=</span> <span class="dv">5788</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># arrival</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>cahoots_arrivals_solo <span class="op">=</span> <span class="dv">14212</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>cahoots_arrivals_assist_public <span class="op">=</span> <span class="dv">5058</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>cahoots_arrivals_check_welfare <span class="op">=</span> <span class="dv">5022</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>cahoots_arrivals_transport <span class="op">=</span> <span class="dv">1587</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># --- EPD Data ---</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>epd_total_calls <span class="op">=</span> <span class="dv">109854</span> </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>epd_dispatches_and_cahoots <span class="op">=</span> <span class="dv">68427</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculated EPD dispatch count (excluding cases with CAHOOTS)</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>epd_dispatches_solo <span class="op">=</span> epd_dispatches_and_cahoots <span class="op">-</span> cahoots_dispatches  </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Gross Divert Rates </span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>diversion_rate_associations <span class="op">=</span> (cahoots_total_assoc <span class="op">/</span> epd_total_calls) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>diversion_rate_dispatches <span class="op">=</span> (cahoots_dispatches <span class="op">/</span> epd_total_calls) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>diversion_rate_cahoots_only_arrivals <span class="op">=</span> (cahoots_arrivals_solo <span class="op">/</span> epd_total_calls) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Diversion Rate (Removing Top 3 Cahoots Calls)</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Methodology error: Calls are not removed from the denom which makes the number artificially lower, it would be closer to 3% otherwise</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>diversion_rate_removing_centric_calls <span class="op">=</span>  ((cahoots_arrivals_solo <span class="op">-</span> cahoots_arrivals_assist_public <span class="op">-</span> cahoots_arrivals_check_welfare <span class="op">-</span> cahoots_arrivals_transport) <span class="op">/</span> epd_total_calls) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># The paper incorrectly presents this number as dealing with dispatches without the top 3 incident types. To replicate the exact numbers, we must use the arrival only cahoots counts in the numerator,</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># but use the total dispactched count in the denominator (while only subtracting the arrival counts from the denominator) . </span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>diversion_rate_removing_centric_calls_dispatch <span class="op">=</span>  ((cahoots_arrivals_solo <span class="op">-</span> cahoots_arrivals_assist_public <span class="op">-</span> cahoots_arrivals_check_welfare <span class="op">-</span> cahoots_arrivals_transport) <span class="op">/</span> </span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>                                                   (epd_dispatches_and_cahoots <span class="op">-</span> cahoots_arrivals_transport <span class="op">-</span> cahoots_arrivals_check_welfare <span class="op">-</span> cahoots_arrivals_assist_public)) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Diversion Rate welfare check adjusted </span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co"># The weirdness continues. The paper claims we are now examining the dispatched cahoots check welfare calls in 2021, citing 5546 as the total number of calls in this category. </span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co"># The problem? Fig. 2 in the paper shows the counts of each dispatched cahoots call type and the true number is 6003. I thought that this might be similar to the calculations above, </span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co"># where arrivals were incorrectly called dispatches. However, for arrivals the number is 5425(Fig. 3) and for strict cahoots arrivals, the number is 5002 (Fig. 5).</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co"># It is possible that this is a result of the figures being generated after more data came in but this should be clarified. </span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Diversion Rate welfare check adjusted (Low)</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>CHECK_WELFARE_EPD_PROBABILITY <span class="op">=</span> <span class="fl">0.74</span> </span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>estimated_epd_check_welfare <span class="op">=</span> CHECK_WELFARE_EPD_PROBABILITY <span class="op">*</span> cahoots_dispatches_check_welfare</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>diversion_rate_adjusted_all_calls <span class="op">=</span> (estimated_epd_check_welfare <span class="op">/</span> epd_total_calls) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Diversion Rate welfare check adjusted (High)</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>diversion_rate_adjusted_dispatched_calls_high <span class="op">=</span> (estimated_epd_check_welfare <span class="op">/</span> (epd_dispatches_and_cahoots <span class="op">-</span> (cahoots_dispatches <span class="op">-</span> estimated_epd_check_welfare))<span class="op">*</span> <span class="dv">100</span> )</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Output ---</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"1a. Diversion Rate (Associations): </span><span class="sc">{</span>diversion_rate_associations<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"1b. Diversion Rate (Dispatches): </span><span class="sc">{</span>diversion_rate_dispatches<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"1c. Diversion Rate (CAHOOTS Only Arrivals): </span><span class="sc">{</span>diversion_rate_cahoots_only_arrivals<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"2a. Diversion Rate (Removing CAHOOTS-Centric Calls): </span><span class="sc">{</span>diversion_rate_removing_centric_calls<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"2b. Diversion Rate (Removing CAHOOTS-Centric Calls, Dispatch only): </span><span class="sc">{</span>diversion_rate_removing_centric_calls_dispatch<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"3a. Diversion Rate (Adjusted for Check Welfare - All Calls): </span><span class="sc">{</span>diversion_rate_adjusted_all_calls<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"3b. Diversion Rate (Adjusted for Check Welfare - Dispatched Calls): </span><span class="sc">{</span>diversion_rate_adjusted_dispatched_calls_high<span class="sc">:.1f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1a. Diversion Rate (Associations): 20.1%
1b. Diversion Rate (Dispatches): 16.5%
1c. Diversion Rate (CAHOOTS Only Arrivals): 12.9%
2a. Diversion Rate (Removing CAHOOTS-Centric Calls): 2.3%
2b. Diversion Rate (Removing CAHOOTS-Centric Calls, Dispatch only): 4.5%
3a. Diversion Rate (Adjusted for Check Welfare - All Calls): 3.7%
3b. Diversion Rate (Adjusted for Check Welfare - Dispatched Calls): 7.5%</code></pre>
</div>
</div>
<section id="to-get-the-final-range-you-have-to-assume-that-the-only-type-of-call-that-cahoots-can-divert-is-a-wellfare-check." class="level3">
<h3 class="anchored" data-anchor-id="to-get-the-final-range-you-have-to-assume-that-the-only-type-of-call-that-cahoots-can-divert-is-a-wellfare-check.">To get the final range you have to assume that the only type of call that cahoots can divert is a wellfare check.</h3>
<div id="cell-7" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>file_path <span class="op">=</span> <span class="st">'Data/cleaned_data/cleaned_CAD_data_2021.csv'</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>cleaned_data <span class="op">=</span> pd.read_csv(file_path)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>datetime_columns <span class="op">=</span> [<span class="st">'Call_Created_Time'</span>, <span class="st">'Call_First_Dispatched_Time'</span>, <span class="st">'Call_First_On_Scene'</span>, <span class="st">'Call_Cleared'</span>]</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> datetime_columns:</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    cleaned_data[col] <span class="op">=</span> pd.to_datetime(cleaned_data[col], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>cleaned_data <span class="op">=</span> cleaned_data.dropna(subset<span class="op">=</span>[<span class="st">'Call_Created_Time'</span>, <span class="st">'Call_Source'</span>, <span class="st">'InitialIncidentTypeDescription'</span>])</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>cleaned_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">IncidentNumber</th>
<th data-quarto-table-cell-role="th">Call_Created_Time</th>
<th data-quarto-table-cell-role="th">Call_First_Dispatched_Time</th>
<th data-quarto-table-cell-role="th">Call_First_On_Scene</th>
<th data-quarto-table-cell-role="th">Call_Cleared</th>
<th data-quarto-table-cell-role="th">Call_Zipcode</th>
<th data-quarto-table-cell-role="th">Beat</th>
<th data-quarto-table-cell-role="th">Call_Source</th>
<th data-quarto-table-cell-role="th">Call_Priority</th>
<th data-quarto-table-cell-role="th">InitialIncidentTypeDescription</th>
<th data-quarto-table-cell-role="th">IsPrimary</th>
<th data-quarto-table-cell-role="th">PrimaryUnitCallSign</th>
<th data-quarto-table-cell-role="th">RespondingUnitCallSign</th>
<th data-quarto-table-cell-role="th">Unit_Dispatched_Time</th>
<th data-quarto-table-cell-role="th">Unit_OnScene_Time</th>
<th data-quarto-table-cell-role="th">Unit_Cleared_Time</th>
<th data-quarto-table-cell-role="th">Disposition</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">Cahoots_related</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>OR-2021-01-01-21000001</td>
<td>2021-01-01 00:00:58</td>
<td>2021-01-01 00:22:41</td>
<td>NaT</td>
<td>2021-01-01 00:22:47</td>
<td>97403.0</td>
<td>EP03</td>
<td>PHONE</td>
<td>5</td>
<td>BEAT INFORMATION</td>
<td>1</td>
<td>6E31</td>
<td>6E31</td>
<td>01/01/2021 00:22:41</td>
<td>NaN</td>
<td>01/01/2021 00:22:47</td>
<td>INFORMATION ONLY</td>
<td>2021</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>OR-2021-01-01-21000002</td>
<td>2021-01-01 00:01:03</td>
<td>NaT</td>
<td>NaT</td>
<td>NaT</td>
<td>97404.0</td>
<td>LS13</td>
<td>E911</td>
<td>5</td>
<td>ILLEGAL FIREWORKS</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>RELAYED TO LANE COUNTY SHERIFFS OFFICE</td>
<td>2021</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>OR-2021-01-01-21000004</td>
<td>2021-01-01 00:01:48</td>
<td>2021-01-01 00:02:53</td>
<td>2021-01-01 00:06:38</td>
<td>2021-01-01 00:23:46</td>
<td>97402.0</td>
<td>EP05</td>
<td>W911</td>
<td>3</td>
<td>TRAFFIC HAZARD</td>
<td>1</td>
<td>4E53</td>
<td>4E53</td>
<td>01/01/2021 00:18:25</td>
<td>01/01/2021 00:18:25</td>
<td>01/01/2021 00:23:46</td>
<td>PATROL CHECK</td>
<td>2021</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>OR-2021-01-01-21000004</td>
<td>2021-01-01 00:01:48</td>
<td>2021-01-01 00:02:53</td>
<td>2021-01-01 00:06:38</td>
<td>2021-01-01 00:23:46</td>
<td>97402.0</td>
<td>EP05</td>
<td>W911</td>
<td>3</td>
<td>TRAFFIC HAZARD</td>
<td>0</td>
<td>4E53</td>
<td>5E47</td>
<td>01/01/2021 00:02:53</td>
<td>01/01/2021 00:06:38</td>
<td>01/01/2021 00:23:33</td>
<td>PATROL CHECK</td>
<td>2021</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>OR-2021-01-01-21000004</td>
<td>2021-01-01 00:01:48</td>
<td>2021-01-01 00:02:53</td>
<td>2021-01-01 00:06:38</td>
<td>2021-01-01 00:23:46</td>
<td>97402.0</td>
<td>EP05</td>
<td>W911</td>
<td>3</td>
<td>TRAFFIC HAZARD</td>
<td>0</td>
<td>4E53</td>
<td>CMD16</td>
<td>01/01/2021 00:07:49</td>
<td>01/01/2021 00:07:49</td>
<td>01/01/2021 00:14:38</td>
<td>PATROL CHECK</td>
<td>2021</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">217278</td>
<td>OR-2021-12-31-21336952</td>
<td>2021-12-31 23:51:41</td>
<td>2021-12-31 23:51:41</td>
<td>2021-12-31 23:51:41</td>
<td>2022-01-01 00:18:31</td>
<td>97401.0</td>
<td>EP02</td>
<td>SELF</td>
<td>P</td>
<td>FIGHT</td>
<td>0</td>
<td>4F64</td>
<td>4E23</td>
<td>01/01/2022 00:02:03</td>
<td>01/01/2022 00:03:28</td>
<td>01/01/2022 00:18:31</td>
<td>CITED IN LIEU OF CUSTODY</td>
<td>2021</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">217279</td>
<td>OR-2021-12-31-21336952</td>
<td>2021-12-31 23:51:41</td>
<td>2021-12-31 23:51:41</td>
<td>2021-12-31 23:51:41</td>
<td>2022-01-01 00:18:31</td>
<td>97401.0</td>
<td>EP02</td>
<td>SELF</td>
<td>P</td>
<td>FIGHT</td>
<td>1</td>
<td>4F64</td>
<td>4F64</td>
<td>12/31/2021 23:51:41</td>
<td>12/31/2021 23:51:41</td>
<td>01/01/2022 00:18:10</td>
<td>CITED IN LIEU OF CUSTODY</td>
<td>2021</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">217280</td>
<td>OR-2021-12-31-21336952</td>
<td>2021-12-31 23:51:41</td>
<td>2021-12-31 23:51:41</td>
<td>2021-12-31 23:51:41</td>
<td>2022-01-01 00:18:31</td>
<td>97401.0</td>
<td>EP02</td>
<td>SELF</td>
<td>P</td>
<td>FIGHT</td>
<td>0</td>
<td>4F64</td>
<td>4F65</td>
<td>12/31/2021 23:51:41</td>
<td>12/31/2021 23:51:41</td>
<td>01/01/2022 00:18:10</td>
<td>CITED IN LIEU OF CUSTODY</td>
<td>2021</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">217281</td>
<td>OR-2021-12-31-21336961</td>
<td>2021-12-31 23:59:50</td>
<td>NaT</td>
<td>NaT</td>
<td>NaT</td>
<td>97402.0</td>
<td>EP05</td>
<td>E911</td>
<td>1</td>
<td>POISONING</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>DISREGARD</td>
<td>2021</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">217282</td>
<td>OR-2021-12-31-21336963</td>
<td>2021-12-31 23:59:59</td>
<td>NaT</td>
<td>NaT</td>
<td>NaT</td>
<td>97401.0</td>
<td>EP02</td>
<td>PHONE</td>
<td>5</td>
<td>INFORMATION - POLICE</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>INFORMATION ONLY</td>
<td>2021</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>217273 rows Ã— 19 columns</p>
</div>
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_police_diversions(cleaned_data, welfare_prop, transport_prop<span class="op">=</span><span class="dv">0</span>, assist_prop<span class="op">=</span><span class="dv">0</span>, suicide_prop<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filtering out the 'SELF' entries from the dataset</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="op">=</span> cleaned_data[cleaned_data[<span class="st">'Call_Source'</span>] <span class="op">!=</span> <span class="st">'SELF'</span>]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ALL CAHOOTS ASSOCIATIONS</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    cahoots_associations <span class="op">=</span> data_filtered[data_filtered[<span class="st">'Cahoots_related'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CAHOOTS DISPATCHED CFS</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    cahoots_dispatched <span class="op">=</span> cahoots_associations.dropna(subset<span class="op">=</span>[<span class="st">'Call_First_Dispatched_Time'</span>])</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    cahoots_dispatched <span class="op">=</span> cahoots_dispatched.drop_duplicates(subset<span class="op">=</span><span class="st">'IncidentNumber'</span>, keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ALL CAHOOTS ONLY ASSOCIATIONS</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    cahoots_only_associations <span class="op">=</span> cahoots_associations[(cahoots_associations[<span class="st">'PrimaryUnitCallSign'</span>] <span class="op">==</span> <span class="st">"CAHOOT"</span>) <span class="op">&amp;</span> (cahoots_associations[<span class="st">'IsPrimary'</span>] <span class="op">==</span> <span class="dv">1</span>)]</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CAHOOTS ONLY ARRIVED CFS</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    cahoots_only_arrived <span class="op">=</span> cahoots_only_associations.dropna(subset<span class="op">=</span>[<span class="st">'Call_First_On_Scene'</span>])</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    cahoots_only_arrived <span class="op">=</span> cahoots_only_arrived.drop_duplicates(subset<span class="op">=</span><span class="st">'IncidentNumber'</span>, keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total CAHOOTS / EPD responses</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    data_unique_incidents <span class="op">=</span> data_filtered.drop_duplicates(subset<span class="op">=</span><span class="st">'IncidentNumber'</span>, keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    combined_cahoots_epd_responses <span class="op">=</span> data_unique_incidents[<span class="op">~</span>(data_unique_incidents[<span class="st">"Call_First_Dispatched_Time"</span>].isna())] <span class="co"># Switch between dispatch and arrival</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate total calls</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    total_calls <span class="op">=</span> data_unique_incidents.shape[<span class="dv">0</span>]</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter top 3 CAHOOTS CFS natures arrive</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    top_3_natures <span class="op">=</span> [<span class="st">'ASSIST PUBLIC- POLICE'</span>, <span class="st">'CHECK WELFARE'</span>, <span class="st">'TRANSPORT'</span>]</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    top_3_cahoots_natures <span class="op">=</span> cahoots_only_arrived[cahoots_only_arrived[<span class="st">'InitialIncidentTypeDescription'</span>].isin(top_3_natures)]</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    top_3_cahoots_natures_count <span class="op">=</span> top_3_cahoots_natures.shape[<span class="dv">0</span>]</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Gross Divert Rates</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    gross_divert_rate_1 <span class="op">=</span> (cahoots_associations.shape[<span class="dv">0</span>] <span class="op">/</span> total_calls) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    gross_divert_rate_2 <span class="op">=</span> (cahoots_dispatched.shape[<span class="dv">0</span>] <span class="op">/</span> total_calls) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    gross_divert_rate_3 <span class="op">=</span> (cahoots_only_arrived.shape[<span class="dv">0</span>] <span class="op">/</span> total_calls) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Divert Rate without top 3 incident types </span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    adjusted_cahoots_only_arrived <span class="op">=</span> cahoots_only_arrived.shape[<span class="dv">0</span>] <span class="op">-</span> top_3_cahoots_natures_count</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    adjusted_divert_rate <span class="op">=</span> (adjusted_cahoots_only_arrived <span class="op">/</span> (total_calls <span class="op">-</span> top_3_cahoots_natures_count) ) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Divert Rate without top 3 incident types Arrived only </span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    adjusted_cahoots_police_arrived <span class="op">=</span> ((cahoots_only_arrived.shape[<span class="dv">0</span>] <span class="op">-</span> top_3_cahoots_natures_count) <span class="op">/</span> </span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>                                          (combined_cahoots_epd_responses.shape[<span class="dv">0</span>] <span class="op">-</span> top_3_cahoots_natures_count)) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Applying 0.74 adjustment to Check Welfare calls</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    likely_check_welfare_diverts_dispatch <span class="op">=</span> (cahoots_dispatched[cahoots_dispatched[<span class="st">"InitialIncidentTypeDescription"</span>] <span class="op">==</span> <span class="st">'CHECK WELFARE'</span>].shape[<span class="dv">0</span>]) <span class="op">*</span> welfare_prop</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    likely_transport_diverts_dispatch <span class="op">=</span> (cahoots_dispatched[cahoots_dispatched[<span class="st">"InitialIncidentTypeDescription"</span>] <span class="op">==</span> <span class="st">'TRANSPORT'</span>].shape[<span class="dv">0</span>]) <span class="op">*</span> transport_prop</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    likely_assist_diverts_dispatch <span class="op">=</span> (cahoots_dispatched[cahoots_dispatched[<span class="st">"InitialIncidentTypeDescription"</span>] <span class="op">==</span> <span class="st">'ASSIST PUBLIC- POLICE'</span>].shape[<span class="dv">0</span>]) <span class="op">*</span> assist_prop</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    likely_suicide_diverts <span class="op">=</span> (cahoots_dispatched[cahoots_dispatched[<span class="st">"InitialIncidentTypeDescription"</span>] <span class="op">==</span> <span class="st">'SUICIDAL SUBJECT'</span>].shape[<span class="dv">0</span>]) <span class="op">*</span> suicide_prop</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    likely_divert_sum <span class="op">=</span> likely_check_welfare_diverts_dispatch <span class="op">+</span> likely_transport_diverts_dispatch <span class="op">+</span> likely_assist_diverts_dispatch <span class="op">+</span> likely_suicide_diverts</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># low estimate</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    adjusted_divert_rate_with_welfare <span class="op">=</span> ((likely_divert_sum) <span class="op">/</span> total_calls) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># High estimate</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    adjusted_divert_rate_with_welfare_high <span class="op">=</span> (likely_divert_sum <span class="op">/</span> ((combined_cahoots_epd_responses.shape[<span class="dv">0</span>]) <span class="op">-</span> (cahoots_dispatched.shape[<span class="dv">0</span>] <span class="op">-</span> likely_divert_sum))) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final Results</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Gross Divert Rate 1 (All Cahoots Associations)"</span>: gross_divert_rate_1,</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Gross Divert Rate 2 (All Cahoots Dispatched CFS)"</span>: gross_divert_rate_2,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Gross Divert Rate 3 (All Cahoots Arrived CFS)"</span>: gross_divert_rate_3,</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Adjusted Divert Rate (Excluding Top 3 Natures)"</span>: adjusted_divert_rate,</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Adjusted Divert Rate (Excluding Top 3 Natures Arrived only)"</span>: adjusted_cahoots_police_arrived,</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Adjusted Divert Rate with Check Welfare Adjustment (low)"</span>: adjusted_divert_rate_with_welfare,</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Adjusted Divert Rate with Check Welfare Adjustment (high)"</span>: adjusted_divert_rate_with_welfare_high</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cahoots_associations'</span>: cahoots_associations,</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cahoots_dispatched'</span>: cahoots_dispatched,</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cahoots_only_associations'</span>: cahoots_only_associations,</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cahoots_only_arrived'</span>: cahoots_only_arrived,</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_cahoots_epd_responses'</span>: combined_cahoots_epd_responses,</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">'results'</span>: results</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>datasets_and_results <span class="op">=</span> run_police_diversions(cleaned_data, <span class="fl">0.74</span>)</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>datasets_and_results[<span class="st">'results'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>{'Gross Divert Rate 1 (All Cahoots Associations)': 20.755246527966392,
 'Gross Divert Rate 2 (All Cahoots Dispatched CFS)': 16.41045140963659,
 'Gross Divert Rate 3 (All Cahoots Arrived CFS)': 13.431835877378816,
 'Adjusted Divert Rate (Excluding Top 3 Natures)': 2.580259655603238,
 'Adjusted Divert Rate (Excluding Top 3 Natures Arrived only)': 5.02929342838992,
 'Adjusted Divert Rate with Check Welfare Adjustment (low)': 4.024462672243649,
 'Adjusted Divert Rate with Check Welfare Adjustment (high)': 8.086088525349998}</code></pre>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">list</span>(datasets_and_results.keys())[:<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a DataFrame from the value counts</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    count_series <span class="op">=</span> datasets_and_results[i][<span class="st">'InitialIncidentTypeDescription'</span>].value_counts()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    top_10 <span class="op">=</span> count_series.head(<span class="dv">10</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    other_count <span class="op">=</span> count_series[<span class="dv">10</span>:].<span class="bu">sum</span>()</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create DataFrame for top 10</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(top_10).reset_index()</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    df.columns <span class="op">=</span> [<span class="st">'Incident Type'</span>, <span class="st">'Count'</span>]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create 'Other' row</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    other_row <span class="op">=</span> pd.DataFrame([{<span class="st">'Incident Type'</span>: <span class="st">'Other'</span>, <span class="st">'Count'</span>: other_count}])</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Concatenate the top 10 DataFrame with the 'Other' row</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.concat([df, other_row], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the percentage of total calls</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    total_calls <span class="op">=</span> count_series.<span class="bu">sum</span>()</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Percentage of Total Calls'</span>] <span class="op">=</span> ((df[<span class="st">'Count'</span>] <span class="op">/</span> total_calls) <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>).astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'%'</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display the DataFrame</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Figure </span><span class="sc">{</span>fig<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    display(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Figure 1: cahoots_associations</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Incident Type</th>
<th data-quarto-table-cell-role="th">Count</th>
<th data-quarto-table-cell-role="th">Percentage of Total Calls</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>CHECK WELFARE</td>
<td>7615</td>
<td>33.22%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>ASSIST PUBLIC- POLICE</td>
<td>7330</td>
<td>31.97%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>TRANSPORT</td>
<td>2352</td>
<td>10.26%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>SUICIDAL SUBJECT</td>
<td>1935</td>
<td>8.44%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>DISORDERLY SUBJECT</td>
<td>543</td>
<td>2.37%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>TRAFFIC HAZARD</td>
<td>444</td>
<td>1.94%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>DISPUTE</td>
<td>328</td>
<td>1.43%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>INTOXICATED SUBJECT</td>
<td>284</td>
<td>1.24%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>CRIMINAL TRESPASS</td>
<td>278</td>
<td>1.21%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>ASSIST FIRE DEPARTMENT</td>
<td>240</td>
<td>1.05%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Other</td>
<td>1576</td>
<td>6.87%</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Figure 2: cahoots_dispatched</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Incident Type</th>
<th data-quarto-table-cell-role="th">Count</th>
<th data-quarto-table-cell-role="th">Percentage of Total Calls</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>CHECK WELFARE</td>
<td>6007</td>
<td>33.14%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>ASSIST PUBLIC- POLICE</td>
<td>5792</td>
<td>31.95%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>TRANSPORT</td>
<td>1808</td>
<td>9.97%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>SUICIDAL SUBJECT</td>
<td>1571</td>
<td>8.67%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>DISORDERLY SUBJECT</td>
<td>457</td>
<td>2.52%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>TRAFFIC HAZARD</td>
<td>372</td>
<td>2.05%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>DISPUTE</td>
<td>256</td>
<td>1.41%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>CRIMINAL TRESPASS</td>
<td>231</td>
<td>1.27%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>INTOXICATED SUBJECT</td>
<td>219</td>
<td>1.21%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>FOUND SYRINGE</td>
<td>192</td>
<td>1.06%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Other</td>
<td>1221</td>
<td>6.74%</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Figure 3: cahoots_only_associations</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Incident Type</th>
<th data-quarto-table-cell-role="th">Count</th>
<th data-quarto-table-cell-role="th">Percentage of Total Calls</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>ASSIST PUBLIC- POLICE</td>
<td>5715</td>
<td>35.02%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>CHECK WELFARE</td>
<td>5708</td>
<td>34.98%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>TRANSPORT</td>
<td>1788</td>
<td>10.96%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>SUICIDAL SUBJECT</td>
<td>1301</td>
<td>7.97%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>TRAFFIC HAZARD</td>
<td>329</td>
<td>2.02%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>DISORDERLY SUBJECT</td>
<td>240</td>
<td>1.47%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>INTOXICATED SUBJECT</td>
<td>206</td>
<td>1.26%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>FOUND SYRINGE</td>
<td>191</td>
<td>1.17%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>ASSIST FIRE DEPARTMENT</td>
<td>178</td>
<td>1.09%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>DISORIENTED SUBJECT</td>
<td>132</td>
<td>0.81%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Other</td>
<td>529</td>
<td>3.24%</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Figure 4: cahoots_only_arrived</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Incident Type</th>
<th data-quarto-table-cell-role="th">Count</th>
<th data-quarto-table-cell-role="th">Percentage of Total Calls</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>CHECK WELFARE</td>
<td>5222</td>
<td>35.2%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>ASSIST PUBLIC- POLICE</td>
<td>5158</td>
<td>34.77%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>TRANSPORT</td>
<td>1606</td>
<td>10.83%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>SUICIDAL SUBJECT</td>
<td>1210</td>
<td>8.16%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>TRAFFIC HAZARD</td>
<td>307</td>
<td>2.07%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>DISORDERLY SUBJECT</td>
<td>218</td>
<td>1.47%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>INTOXICATED SUBJECT</td>
<td>187</td>
<td>1.26%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>ASSIST FIRE DEPARTMENT</td>
<td>163</td>
<td>1.1%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>FOUND SYRINGE</td>
<td>160</td>
<td>1.08%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>DISORIENTED SUBJECT</td>
<td>124</td>
<td>0.84%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Other</td>
<td>481</td>
<td>3.24%</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Figure 5: total_cahoots_epd_responses</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Incident Type</th>
<th data-quarto-table-cell-role="th">Count</th>
<th data-quarto-table-cell-role="th">Percentage of Total Calls</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>CHECK WELFARE</td>
<td>8666</td>
<td>12.62%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>DISPUTE</td>
<td>6447</td>
<td>9.39%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>ASSIST PUBLIC- POLICE</td>
<td>6086</td>
<td>8.86%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>CRIMINAL TRESPASS</td>
<td>4975</td>
<td>7.25%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>BEAT INFORMATION</td>
<td>4851</td>
<td>7.07%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>DISORDERLY SUBJECT</td>
<td>3597</td>
<td>5.24%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>SUICIDAL SUBJECT</td>
<td>1973</td>
<td>2.87%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>TRANSPORT</td>
<td>1866</td>
<td>2.72%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>SUSPICIOUS CONDITIONS</td>
<td>1779</td>
<td>2.59%</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>TRAFFIC HAZARD</td>
<td>1745</td>
<td>2.54%</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Other</td>
<td>26669</td>
<td>38.85%</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="we-now-have-a-small-over-estimation-but-this-overestimation-is-consistent-across-datasets-so-it-can-be-corrected-for" class="level3">
<h3 class="anchored" data-anchor-id="we-now-have-a-small-over-estimation-but-this-overestimation-is-consistent-across-datasets-so-it-can-be-corrected-for">We now have a small over estimation but this overestimation is consistent across datasets so it can be corrected for</h3>
</section>
</section>
<section id="problems" class="level1">
<h1>Problems</h1>
<ul>
<li><p>Assumption of Uniform Impact: The analysis assumes that the impact of Cahoots on diversion rates is uniform across all incident types. This does not factor in which CAD call types are appropriate for Cahoots.</p></li>
<li><p>The approach of simply excluding the top three Cahoots-centric incident types assumes that these calls would never require police intervention. However, police still Respond to quite a few of these call types.</p></li>
<li><p>Trying to measure what call volume would be if Cahoots did not exist does not make sense since Cahoots provides other preventative community services that could reduce call volume.</p></li>
<li><p>The methodology for the 74% figure is vauge and somewhat subjective (Based on Dispatchers opinion)</p></li>
</ul>
</section>
<section id="natural-experiment" class="level1">
<h1>Natural Experiment</h1>
<p>The Eugene Police Department (EPD) claims that 74% of â€œCheck Welfareâ€ calls are eligible for diversion by CAHOOTS. This figure, derived from a 2019 analysis of 200 calls, lacks transparency in its methodology and relies solely on the opinions of an unspecified number of dispatchers, raising concerns about its reliability.</p>
<p>While itâ€™s impossible to definitively determine the impact of CAHOOTSâ€™ absence, we can analyze the programâ€™s expansion in 2017. Before then, calls received between the hours 5am-10am fell under the EPDâ€™s jurisdiction and, theoretically, were eligible for diversion. If the 74% figure holds true, we should see a significant increase in dispatched calls for non-divertible incident types between 2016 and 2017, after CAHOOTS expanded its service hours.</p>
<p>Indeed, comparing the ratio of calls between 2016 and 2017 for each incident type can provide a more objective basis for adjusting the estimated proportion of calls eligible for diversion. This approach minimizes reliance on subjective assessments and offers a more data-driven perspective on the true proportion of divertable calls. Future research could establish a more robust baseline with access to data going back farther than 2016.</p>
<section id="standard-data-cleaning" class="level3">
<h3 class="anchored" data-anchor-id="standard-data-cleaning">Standard data cleaning</h3>
<div id="cell-15" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>CAD_data <span class="op">=</span> pd.read_csv(<span class="st">"data/call_data_from_CAD.csv"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>CAD_data[<span class="st">"Call_Created_Time"</span>] <span class="op">=</span> pd.to_datetime(CAD_data[<span class="st">'Call_Created_Time'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>CAD_data[<span class="st">"year"</span>] <span class="op">=</span> CAD_data[<span class="st">"Call_Created_Time"</span>].dt.year</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>CAD_data[<span class="st">"Call_First_Dispatched_Time"</span>] <span class="op">=</span> pd.to_datetime(CAD_data[<span class="st">'Call_First_Dispatched_Time'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize Cahoots identifiers </span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>cahoots_identifiers <span class="op">=</span> <span class="vs">r"1J77\s*|3J79\s*|3J78\s*|3J77\s*|4J79\s*|3J81\s*|3J76\s*|2J28\s*|2J29\s*|CAHOOT\s*|CAHOT\s*|CAHO\s*"</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>CAD_data[<span class="st">"PrimaryUnitCallSign"</span>] <span class="op">=</span> CAD_data[<span class="st">"PrimaryUnitCallSign"</span>].replace(cahoots_identifiers, <span class="st">'CAHOOT'</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>CAD_data[<span class="st">"RespondingUnitCallSign"</span>] <span class="op">=</span> CAD_data[<span class="st">"RespondingUnitCallSign"</span>].replace(cahoots_identifiers, <span class="st">'CAHOOT'</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize Cahoots identifiers </span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>cahoots_identifiers <span class="op">=</span> <span class="vs">r"1J77\s*|3J79\s*|3J78\s*|3J77\s*|4J79\s*|3J81\s*|3J76\s*|2J28\s*|2J29\s*|CAHOOT\s*|CAHOT\s*|CAHO\s*"</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>CAD_data[<span class="st">"PrimaryUnitCallSign"</span>] <span class="op">=</span> CAD_data[<span class="st">"PrimaryUnitCallSign"</span>].replace(cahoots_identifiers, <span class="st">'CAHOOT'</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>CAD_data[<span class="st">"RespondingUnitCallSign"</span>] <span class="op">=</span> CAD_data[<span class="st">"RespondingUnitCallSign"</span>].replace(cahoots_identifiers, <span class="st">'CAHOOT'</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an identifier for Cahoots involvement </span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>CAD_data[<span class="st">'Cahoots_related'</span>] <span class="op">=</span> ((CAD_data[<span class="st">'PrimaryUnitCallSign'</span>] <span class="op">==</span> <span class="st">'CAHOOT'</span>) <span class="op">|</span> (CAD_data[<span class="st">'RespondingUnitCallSign'</span>] <span class="op">==</span> <span class="st">'CAHOOT'</span>)).astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-16" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>CAD_data <span class="op">=</span> CAD_data[CAD_data[<span class="st">'Call_Source'</span>] <span class="op">!=</span> <span class="st">'SELF'</span>].copy()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>CAD_data.drop(columns<span class="op">=</span>[<span class="st">"Unnamed: 0"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data_2016 <span class="op">=</span> CAD_data[(CAD_data[<span class="st">"Call_First_Dispatched_Time"</span>].dt.year <span class="op">==</span> <span class="dv">2016</span>) <span class="op">&amp;</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                         (CAD_data[<span class="st">"Call_First_Dispatched_Time"</span>].dt.hour <span class="op">&gt;=</span> <span class="dv">5</span>) <span class="op">&amp;</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                         (CAD_data[<span class="st">"Call_First_Dispatched_Time"</span>].dt.hour <span class="op">&lt;</span> <span class="dv">10</span>)].copy()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>data_2017 <span class="op">=</span> CAD_data[(CAD_data[<span class="st">"Call_First_Dispatched_Time"</span>].dt.year <span class="op">==</span> <span class="dv">2017</span>) <span class="op">&amp;</span> </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                         (CAD_data[<span class="st">"Call_First_Dispatched_Time"</span>].dt.hour <span class="op">&gt;=</span> <span class="dv">5</span>) <span class="op">&amp;</span> </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                         (CAD_data[<span class="st">"Call_First_Dispatched_Time"</span>].dt.hour <span class="op">&lt;</span> <span class="dv">10</span>)].copy()</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>data_2016.dropna(subset<span class="op">=</span>[<span class="st">'Call_First_Dispatched_Time'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>data_2017.dropna(subset<span class="op">=</span>[<span class="st">'Call_First_Dispatched_Time'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="running-the-experiment" class="level2">
<h2 class="anchored" data-anchor-id="running-the-experiment">Running the Experiment</h2>
<div id="cell-19" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_prop(data_2016, data_2017, types):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    dict_2016 <span class="op">=</span> data_2016[data_2016[<span class="st">"InitialIncidentTypeDescription"</span>].isin(types)][<span class="st">"InitialIncidentTypeDescription"</span>].value_counts().to_dict()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    dict_2017 <span class="op">=</span> data_2017[data_2017[<span class="st">"InitialIncidentTypeDescription"</span>].isin(types)][<span class="st">"InitialIncidentTypeDescription"</span>].value_counts().to_dict()</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dict_2016)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dict_2017)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    final_dict <span class="op">=</span> {}</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> incident <span class="kw">in</span> dict_2016:</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        final_dict[incident] <span class="op">=</span> dict_2016[incident] <span class="op">/</span> dict_2017[incident]</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_dict</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>calculate_prop(data_2016, data_2017, [<span class="st">"CHECK WELFARE"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'CHECK WELFARE': 1310}
{'CHECK WELFARE': 1361}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>{'CHECK WELFARE': 0.9625275532696547}</code></pre>
</div>
</div>
<div id="cell-20" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>data_2017[<span class="st">"InitialIncidentTypeDescription"</span>].value_counts().to_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>{'DISPUTE': 1499,
 'CRIMINAL TRESPASS': 1477,
 'CHECK WELFARE': 1361,
 'DISORDERLY SUBJECT': 874,
 'TRANSPORT': 585,
 'ASSIST PUBLIC- POLICE': 583,
 'BURGLARY': 573,
 'SUSPICIOUS CONDITIONS': 571,
 'ILLEGAL CAMPING': 519,
 'SUSPICIOUS SUBJECT': 440,
 'BEAT INFORMATION': 411,
 'TRAFFIC HAZARD': 335,
 'MOTOR VEH ACC UNKNOWN INJ': 324,
 'SUICIDAL SUBJECT': 323,
 'UNAUTHORIZED USE OF VEHICLE': 242,
 'THEFT': 183,
 'ASSAULT': 160,
 'LOCATION WANTED SUBJECT': 136,
 'HARASSMENT': 132,
 'CARDIAC ARREST': 119,
 'HIT AND RUN': 114,
 'INCOMPLETE CALL': 111,
 'UNKNOWN PROBLEM': 109,
 'ALARM PANIC': 109,
 'ROBBERY': 105,
 'LOUD NOISE': 97,
 'SHOTS FIRED': 96,
 'MOTOR VEH ACC NO INJURY': 94,
 'SUSPICIOUS VEHICLE': 93,
 'FOUND SYRINGE': 89,
 'ASSIST FIRE DEPARTMENT': 86,
 'OVERDOSE': 84,
 'VIOLATION OF RESTRAINING ORDER': 80,
 'ATTEMPT TO LOCATE DRUNK DRIVER': 76,
 'ASSIST OUTSIDE AGENCY': 75,
 'MISSING PERSON': 73,
 'CRIMINAL MISCHIEF': 72,
 'FOLLOW UP': 70,
 'ARMED SUBJECT': 65,
 'AUDIBLE ALARM': 65,
 'ALARM HOLD UP': 64,
 'STAB WOUND': 60,
 'DOG AT LARGE': 59,
 'INFORMATION - POLICE': 56,
 'ALARM DURESS': 55,
 'THEFT FROM VEHICLE': 53,
 'GUNSHOT WOUND': 52,
 'DRUG INFO': 51,
 'RECOVERED STOLEN VEHICLE': 49,
 'LOCATION STOLEN VEHICLE': 49,
 'MENACING': 49,
 'SUBJECT SCREAMING': 49,
 'DECEASED SUBJECT': 45,
 'INTOXICATED SUBJECT': 45,
 'VEHICLE/PEDESTRIAN CRASH': 44,
 'RECKLESS DRIVING': 43,
 'DISABLED VEHICLE': 42,
 'ASSAULT WITH INJURY': 42,
 'WARRANT SERVICE': 40,
 'OPEN DOOR': 39,
 'INJURED ANIMAL': 39,
 'FOUND ANIMAL': 38,
 'MOTOR VEH ACC INJURY': 36,
 'RUNAWAY JUVENILE': 36,
 'UNATTENDED CHILDREN': 36,
 'FRAUD': 35,
 'FOUND PROPERTY': 35,
 'INDECENT EXPOSURE': 33,
 'ILLEGAL BURNING': 32,
 'ACCIDENT VEHICLE BIKE': 31,
 'FORGERY': 31,
 'FOUND CONTRABAND': 31,
 'PROWLER': 30,
 'DISORDERLY JUVENILES': 28,
 'DISPUTE FAMILY': 28,
 'TREE DOWN': 28,
 'SUICIDE': 27,
 'VIOLATION OF CITY ORDINANCE': 27,
 'DOG VICIOUS': 26,
 'BLOCKED DRIVEWAY': 25,
 'SUBJECT DOWN': 24,
 'DISORIENTED SUBJECT': 24,
 'LOCATE MISSING PERSON': 24,
 'RECKLESS ENDANGERING': 24,
 'SEX ABUSE': 23,
 'ANIMAL CRUELTY': 23,
 'ILLEGAL DUMPING': 23,
 'REQUEST COVER': 22,
 'UNLAWFUL VEHICLE ENTRY': 22,
 'TRAFFIC SIGNAL MALFUNCTION': 22,
 'NUDE SUBJECT': 20,
 'ANIMAL COMPLAINT': 20,
 'FIGHT': 20,
 'ILLEGAL PARKING': 18,
 'ALARM': 18,
 'ASSIST SHERIFFS OFFICE': 18,
 'GRAFFITI': 17,
 'RECKLESS BURNING': 17,
 'THEFT OF SERVICES': 15,
 'CHILD ABUSE': 15,
 'SUSPICIOUS DEVICE': 14,
 'CUSTODIAL INTERFERENCE': 14,
 'LOCATION STOLEN PROPERTY': 13,
 'ALARM SILENT': 13,
 'ATTEMPT TO LOCATE': 13,
 'ANIMAL ABUSE': 12,
 'LOCATION RUNAWAY': 11,
 'BLOCKED SIDEWALK': 11,
 'HAZARD SAFETY': 10,
 'ABANDONED ANIMAL': 10,
 'ARMED DISPUTE': 9,
 'DISORDERLY MEDICAL TRANSPORT': 9,
 'FOUND CHILD': 9,
 'THEFT OF MAIL': 8,
 'DUII': 8,
 'CIVIL STANDBY': 8,
 'SHOPLIFT 3050 PROGRAM': 7,
 'WATER RESCUE': 7,
 'MISSING JUVENILE': 7,
 'BLOCKED ALLEY': 7,
 'GAS LEAK': 7,
 'BOMB THREAT': 7,
 'THEFT OF BICYCLE': 7,
 'STOP SIGN DOWN': 7,
 'EXPLOSION': 6,
 'ANIMAL AT LARGE': 6,
 'ASSIST OREGON STATE POLICE': 6,
 'RAPE': 6,
 'PUBLIC INDECENCY': 6,
 'OPEN CONTAINER': 6,
 'SWITCHED PLATE': 5,
 'EMERGENCY MESSAGE': 5,
 'ILLEGAL DISCHARGE FIREARM': 5,
 'PARKING VIOLATION': 5,
 'DAMAGE CITY PROPERTY': 5,
 'DOG BITE': 5,
 'INTIMIDATION': 5,
 'ACCIDENT BIKE': 5,
 'TRAFFIC STOP': 4,
 'MINOR IN POSSESSION': 4,
 'LOUD PARTY': 4,
 'INJURED SUBJECT': 4,
 'TRASH BIN FIRE': 4,
 'LOUD CONSTRUCTION': 3,
 'HAZARDOUS MATERIAL': 3,
 'DEATH MESSAGE': 3,
 'REQUEST DRE': 3,
 'TRAFFIC COMPLAINT': 3,
 'DOWN LINE': 3,
 'ARSON': 2,
 'VEHICLE IN WATER': 2,
 'DEAD ANIMAL': 2,
 'THEFT BY DECEPTION': 2,
 'ANIMAL ATTACK/BITE': 2,
 'SIGN DOWN': 2,
 'ASSIST PUBLIC WORKS': 2,
 'OPEN WINDOW': 2,
 'DOG BARKING': 2,
 'DISORDERLY PARTY': 2,
 'ELDERLY ABUSE': 2,
 'ILLEGAL FIREWORKS': 2,
 'HAZARDOUS SPILL': 1,
 'LIVESTOCK AT LARGE': 1,
 'STALKING COMPLAINT': 1,
 'INFORMATION- BOTH PD AND FD': 1,
 'WATER PROBLEM': 1,
 'WALKAWAY': 1,
 'CRIME INFORMATION': 1,
 'SPEEDING VEHICLE': 1,
 'POISONING': 1,
 'COMPUTER CRIME': 1,
 'ANIMAL BITE': 1,
 'KIDNAP': 1,
 'WRONG WAY DRIVER': 1}</code></pre>
</div>
</div>
<p>For the Check welfare category, we find very little change in call volume from 2016 to 2017 during the hours of 5am - 10am. This indicates that the vast majority of Check Welfare calls are eligible for diversion, and that the 0.74 figure is likely an significant undercount. Keeping all else equal, letâ€™s rerun the diversion rates:</p>
<div id="cell-22" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>welfare_prop <span class="op">=</span> calculate_prop(data_2016, data_2017, [<span class="st">"CHECK WELFARE"</span>])[<span class="st">"CHECK WELFARE"</span>]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>wellfare_corrected_results <span class="op">=</span> run_police_diversions(cleaned_data, welfare_prop, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>wellfare_corrected_results[<span class="st">'results'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'CHECK WELFARE': 1310}
{'CHECK WELFARE': 1361}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>{'Gross Divert Rate 1 (All Cahoots Associations)': 20.755246527966392,
 'Gross Divert Rate 2 (All Cahoots Dispatched CFS)': 16.41045140963659,
 'Gross Divert Rate 3 (All Cahoots Arrived CFS)': 13.431835877378816,
 'Adjusted Divert Rate (Excluding Top 3 Natures)': 2.580259655603238,
 'Adjusted Divert Rate (Excluding Top 3 Natures Arrived only)': 5.02929342838992,
 'Adjusted Divert Rate with Check Welfare Adjustment (low)': 5.234670552891535,
 'Adjusted Divert Rate with Check Welfare Adjustment (high)': 10.268003855748532}</code></pre>
</div>
</div>
<p>With no other adjustments, our diversion rate is now somewhere between 5% - 10%. However, in reality, check welfare is far from the only divertable call type. Letâ€™s now examine the proportions of the top 4 cahoots incident types and consider them in our calculations.</p>
<div id="cell-24" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>incidents <span class="op">=</span> [<span class="st">"CHECK WELFARE"</span>, <span class="st">"TRANSPORT"</span>, <span class="st">"ASSIST PUBLIC- POLICE"</span>, <span class="st">"SUICIDAL SUBJECT"</span>]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>correct_props <span class="op">=</span> calculate_prop(data_2016, data_2017, incidents)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>correct_props</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'CHECK WELFARE': 1310, 'SUICIDAL SUBJECT': 253, 'ASSIST PUBLIC- POLICE': 134, 'TRANSPORT': 87}
{'CHECK WELFARE': 1361, 'TRANSPORT': 585, 'ASSIST PUBLIC- POLICE': 583, 'SUICIDAL SUBJECT': 323}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>{'CHECK WELFARE': 0.9625275532696547,
 'SUICIDAL SUBJECT': 0.7832817337461301,
 'ASSIST PUBLIC- POLICE': 0.22984562607204118,
 'TRANSPORT': 0.14871794871794872}</code></pre>
</div>
</div>
<div id="cell-25" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>welfare_prop <span class="op">=</span> correct_props[<span class="st">"CHECK WELFARE"</span>]</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>transport_prop <span class="op">=</span> correct_props[<span class="st">"TRANSPORT"</span>]</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>assist_prop <span class="op">=</span> correct_props[<span class="st">"ASSIST PUBLIC- POLICE"</span>]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>suicide_prop <span class="op">=</span> correct_props[<span class="st">"SUICIDAL SUBJECT"</span>]</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>top_3_corrected_results <span class="op">=</span> run_police_diversions(cleaned_data, welfare_prop, transport_prop, assist_prop, suicide_prop)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>top_3_corrected_results[<span class="st">'results'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>{'Gross Divert Rate 1 (All Cahoots Associations)': 20.755246527966392,
 'Gross Divert Rate 2 (All Cahoots Dispatched CFS)': 16.41045140963659,
 'Gross Divert Rate 3 (All Cahoots Arrived CFS)': 13.431835877378816,
 'Adjusted Divert Rate (Excluding Top 3 Natures)': 2.580259655603238,
 'Adjusted Divert Rate (Excluding Top 3 Natures Arrived only)': 5.02929342838992,
 'Adjusted Divert Rate with Check Welfare Adjustment (low)': 7.797441952031886,
 'Adjusted Divert Rate with Check Welfare Adjustment (high)': 14.562903478797923}</code></pre>
</div>
</div>
<p>With these adjustments our range is now 8% - 15%. Our low end estimation has now caught up with the EPDâ€™s max estimate suggesting that the proportion of divertable call types is much higher than originally claimed. This number is still a low ball estimate in many respects but this serves as a useful baseline diversion rate.</p>
<div id="cell-27" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>CAD_data_diversions <span class="op">=</span> pd.read_csv(<span class="st">"data/cleaned_data/cleaned_CAD_data_diversions.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-28" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>datetime_columns <span class="op">=</span> [<span class="st">'Call_Created_Time'</span>, <span class="st">'Call_First_Dispatched_Time'</span>, <span class="st">'Call_First_On_Scene'</span>, <span class="st">'Call_Cleared'</span>]</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> datetime_columns:</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    CAD_data_diversions[col] <span class="op">=</span> pd.to_datetime(CAD_data_diversions[col], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>CAD_data_cleaned <span class="op">=</span> CAD_data_diversions.dropna(subset<span class="op">=</span>[<span class="st">'Call_Created_Time'</span>, <span class="st">'Call_Source'</span>, <span class="st">'InitialIncidentTypeDescription'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-29" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>test <span class="op">=</span> run_police_diversions(CAD_data_cleaned[CAD_data_cleaned[<span class="st">"Call_Created_Time"</span>].dt.year <span class="op">==</span> <span class="dv">2017</span>], welfare_prop)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>test[<span class="st">'results'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>{'Gross Divert Rate 1 (All Cahoots Associations)': 20.1387881926463,
 'Gross Divert Rate 2 (All Cahoots Dispatched CFS)': 16.16882444329363,
 'Gross Divert Rate 3 (All Cahoots Arrived CFS)': 12.827550491973073,
 'Adjusted Divert Rate (Excluding Top 3 Natures)': 2.310719834282755,
 'Adjusted Divert Rate (Excluding Top 3 Natures Arrived only)': 4.4692401690739,
 'Adjusted Divert Rate with Check Welfare Adjustment (low)': 4.39542618577515,
 'Adjusted Divert Rate with Check Welfare Adjustment (high)': 8.71310065330718}</code></pre>
</div>
</div>
<div id="cell-30" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>CAD_data_cleaned_filter <span class="op">=</span> CAD_data_cleaned[(CAD_data_cleaned[<span class="st">"Call_Created_Time"</span>].dt.year <span class="op">&gt;=</span> <span class="dv">2017</span>) <span class="op">&amp;</span> (CAD_data_cleaned[<span class="st">"Call_Created_Time"</span>].dt.year <span class="op">&lt;=</span> <span class="dv">2021</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-31" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>test <span class="op">=</span> run_police_diversions(CAD_data_cleaned_filter[CAD_data_cleaned_filter[<span class="st">"Call_Created_Time"</span>].dt.year <span class="op">&gt;=</span> <span class="dv">2017</span>], welfare_prop, transport_prop, assist_prop, suicide_prop)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>test[<span class="st">'results'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>{'Gross Divert Rate 1 (All Cahoots Associations)': 20.676778100114873,
 'Gross Divert Rate 2 (All Cahoots Dispatched CFS)': 16.730593251689026,
 'Gross Divert Rate 3 (All Cahoots Arrived CFS)': 13.472479118397226,
 'Adjusted Divert Rate (Excluding Top 3 Natures)': 2.475613792566344,
 'Adjusted Divert Rate (Excluding Top 3 Natures Arrived only)': 4.859972403459888,
 'Adjusted Divert Rate with Check Welfare Adjustment (low)': 7.3368560813049895,
 'Adjusted Divert Rate with Check Welfare Adjustment (high)': 13.963800157749395}</code></pre>
</div>
</div>
<div id="cell-32" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>diversion_rates_by_year <span class="op">=</span> {}</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> year <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2017</span>, <span class="dv">2022</span>):  <span class="co"># Loop through years 2017 to 2021</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter data for the current year</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    yearly_data <span class="op">=</span> CAD_data_cleaned[CAD_data_cleaned[<span class="st">"Call_Created_Time"</span>].dt.year <span class="op">==</span> year]</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate diversion rates for the filtered yearly data</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    yearly_rates <span class="op">=</span> run_police_diversions(yearly_data, welfare_prop, transport_prop, assist_prop, suicide_prop)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store the results in the dictionary</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    diversion_rates_by_year[year] <span class="op">=</span> yearly_rates[<span class="st">'results'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg ansi-bold">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg ansi-bold">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg ansi-bold">In[1], line 4</span>
<span class="ansi-green-fg">      1</span> diversion_rates_by_year <span style="color:rgb(98,98,98)">=</span> {}
<span class="ansi-green-fg">      2</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> year <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">range</span>(<span style="color:rgb(98,98,98)">2017</span>, <span style="color:rgb(98,98,98)">2022</span>):  <span style="font-style:italic;color:rgb(95,135,135)"># Loop through years 2017 to 2021</span>
<span class="ansi-green-fg">      3</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Filter data for the current year</span>
<span class="ansi-green-fg ansi-bold">----&gt; 4</span>     yearly_data <span style="color:rgb(98,98,98)">=</span> CAD_data_cleaned[CAD_data_cleaned[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Call_Created_Time</span><span style="color:rgb(175,0,0)">"</span>]<span style="color:rgb(98,98,98)">.</span>dt<span style="color:rgb(98,98,98)">.</span>year <span style="color:rgb(98,98,98)">==</span> year]
<span class="ansi-green-fg">      6</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Calculate diversion rates for the filtered yearly data</span>
<span class="ansi-green-fg">      7</span>     yearly_rates <span style="color:rgb(98,98,98)">=</span> run_police_diversions(yearly_data, welfare_prop, transport_prop, assist_prop, suicide_prop)

<span class="ansi-red-fg ansi-bold">NameError</span>: name 'CAD_data_cleaned' is not defined</pre>
</div>
</div>
</div>
<div id="cell-33" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_diversion_rate_chart(data, rate_key, low_estimate_key<span class="op">=</span><span class="va">None</span>, </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                                 title<span class="op">=</span><span class="va">None</span>, rate_label<span class="op">=</span><span class="va">None</span>, low_estimate_label<span class="op">=</span><span class="st">'Low Estimate'</span>):</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates a stacked bar chart showing diversion rates by year.</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">        data (dict): A dictionary where keys are years and values are</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co">                     dictionaries containing diversion rate information.</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co">        rate_key (str): The key for the diversion rate to plot.</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co">        low_estimate_key (str, optional): The key for the low-end estimate </span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="co">                                           to add as a line. If None, no line </span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="co">                                           is added. Defaults to None.</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="co">        title (str, optional): Title for the plot. If None, a default title is used.</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="co">        rate_label (str, optional): Label for the main rate in the legend. </span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="co">                                    If None, the `rate_key` is used as the label.</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="co">        low_estimate_label (str, optional): Label for the low estimate line </span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="co">                                            in the legend. Defaults to 'Low Estimate'.</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    years <span class="op">=</span> <span class="bu">list</span>(data.keys())</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    rates <span class="op">=</span> <span class="bu">list</span>(data.values())</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    selected_rates <span class="op">=</span> [rate[rate_key] <span class="cf">for</span> rate <span class="kw">in</span> rates]</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>    plt.bar(years, selected_rates, label<span class="op">=</span>rate_label <span class="cf">if</span> rate_label <span class="cf">else</span> rate_key, color<span class="op">=</span><span class="st">'darkorange'</span>)</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>    plt.bar(years, [<span class="dv">100</span> <span class="op">-</span> r <span class="cf">for</span> r <span class="kw">in</span> selected_rates], bottom<span class="op">=</span>selected_rates, label<span class="op">=</span><span class="st">'Police'</span>, color<span class="op">=</span><span class="st">'lightblue'</span>)</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> low_estimate_key:</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>        low_estimates <span class="op">=</span> [rate[low_estimate_key] <span class="cf">for</span> rate <span class="kw">in</span> rates]</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>        low_end_lines <span class="op">=</span> plt.hlines(</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>            low_estimates,</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>            xmin<span class="op">=</span>[y <span class="op">-</span> <span class="fl">0.4</span> <span class="cf">for</span> y <span class="kw">in</span> years],</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>            xmax<span class="op">=</span>[y <span class="op">+</span> <span class="fl">0.4</span> <span class="cf">for</span> y <span class="kw">in</span> years],</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>        plt.legend(handles<span class="op">=</span>[low_end_lines] <span class="op">+</span> plt.gca().get_legend_handles_labels()[<span class="dv">0</span>],</span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>                   labels<span class="op">=</span>[low_estimate_label] <span class="op">+</span> plt.gca().get_legend_handles_labels()[<span class="dv">1</span>],</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>                   loc<span class="op">=</span><span class="st">'upper left'</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>        plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Year'</span>)</span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Diversion Rate (%)'</span>)</span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>    plt.title(title <span class="cf">if</span> title <span class="cf">else</span> <span class="ss">f'Diversion Rates Over Time (</span><span class="sc">{</span>rate_key<span class="sc">}</span><span class="ss">)'</span>)</span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>    plt.xticks(years)</span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a>    plt.ylim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add percentage labels </span></span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> year, high, low <span class="kw">in</span> <span class="bu">zip</span>(years, selected_rates, low_estimates <span class="cf">if</span> low_estimate_key <span class="cf">else</span> [<span class="dv">0</span>]<span class="op">*</span><span class="bu">len</span>(years)):</span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a>        plt.text(year, <span class="dv">20</span>, <span class="ss">f'</span><span class="sc">{</span>high<span class="sc">:.1f}</span><span class="ss">%'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">#plt.text(year, (low + 3), f'{low:.1f}%', ha='center', va='center', color='black') </span></span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a>create_diversion_rate_chart(</span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a>    diversion_rates_by_year,</span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a>    rate_key<span class="op">=</span><span class="st">'Gross Divert Rate 2 (All Cahoots Dispatched CFS)'</span>,</span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a>    low_estimate_key<span class="op">=</span><span class="st">'Adjusted Divert Rate with Check Welfare Adjustment (low)'</span>,</span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'CAHOOTS Diversions By Year'</span>,</span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a>    rate_label<span class="op">=</span><span class="st">'Cahoots'</span>,</span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a>    low_estimate_label<span class="op">=</span><span class="st">'Low Estimate'</span> </span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="police_replication_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-34" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>create_diversion_rate_chart(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    diversion_rates_by_year,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    rate_key<span class="op">=</span><span class="st">'Adjusted Divert Rate with Check Welfare Adjustment (high)'</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    low_estimate_key<span class="op">=</span><span class="st">'Adjusted Divert Rate with Check Welfare Adjustment (low)'</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'CAHOOTS Diversion Rate by year'</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    rate_label<span class="op">=</span><span class="st">'Cahoots'</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    low_estimate_label<span class="op">=</span><span class="st">'Low Estimate'</span> </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="police_replication_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-35" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scripts.tree <span class="im">import</span> create_treemap</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-36" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.cm <span class="im">as</span> cm</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>tab20_colormap <span class="op">=</span> cm.get_cmap(<span class="st">'tab20b'</span>, <span class="dv">20</span>)  <span class="co"># Ensure it has 20 colors</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the colors as hex strings</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>tab20_colors <span class="op">=</span> [matplotlib.colors.rgb2hex(tab20_colormap(i)) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(tab20_colormap.N)]</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.colors <span class="im">as</span> mcolors</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a palette with 20 unique colors</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> sns.color_palette(<span class="st">"pastel"</span>)</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>hex_colors <span class="op">=</span> [mcolors.rgb2hex(color) <span class="cf">for</span> color <span class="kw">in</span> colors]</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>colorblind_friendly_palette <span class="op">=</span> [</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#009E73'</span>,  <span class="co"># Green</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#E69F00'</span>,  <span class="co"># Gold/Orange</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#56B4E9'</span>,  <span class="co"># Light Blue</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#D55E00'</span>,  <span class="co"># Red-Orange/Brown</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#CC79A7'</span>,  <span class="co"># Pink/Purple</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#F0E442'</span>,  <span class="co"># Yellow (use sparingly)</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#999999'</span>,  <span class="co"># Gray</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#363737'</span>,  <span class="co"># Blackish</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#80B1D3'</span>,  <span class="co"># Light Blue</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#FDB462'</span>,  <span class="co"># Light Orange</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#B3DE69'</span>,  <span class="co"># Light Green</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#BC80BD'</span>,  <span class="co"># Purple</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#FFED6F'</span>,  <span class="co"># Light Yellow</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#FB8072'</span>,  <span class="co"># Salmon</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'#1F78B4'</span>,  <span class="co"># Dark Blue</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>cahoots_data <span class="op">=</span> CAD_data_cleaned[CAD_data_cleaned[<span class="st">'Cahoots_related'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>police_data <span class="op">=</span> CAD_data_cleaned[CAD_data_cleaned[<span class="st">'Cahoots_related'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a><span class="co">#create_treemap(cahoots_data, 'Cahoots Incident Types', top_n=200, group_others=True, max_legend_entries=10, show_labels=True, color_list=colors, min_label_area_ratio=0.01)</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>create_treemap(police_data, <span class="st">'Police Incident Types'</span>, top_n<span class="op">=</span><span class="dv">62</span>, group_others<span class="op">=</span><span class="va">True</span>, max_legend_entries<span class="op">=</span><span class="dv">10</span>, show_labels<span class="op">=</span><span class="va">True</span>, color_list<span class="op">=</span>colors, min_label_area_ratio<span class="op">=</span><span class="fl">0.014</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Nathan Burton\AppData\Local\Temp\ipykernel_14468\2511957423.py:4: MatplotlibDeprecationWarning: The get_cmap function was deprecated in Matplotlib 3.7 and will be removed two minor releases later. Use ``matplotlib.colormaps[name]`` or ``matplotlib.colormaps.get_cmap(obj)`` instead.
  tab20_colormap = cm.get_cmap('tab20b', 20)  # Ensure it has 20 colors</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="police_replication_files/figure-html/cell-23-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>